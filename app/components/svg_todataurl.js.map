{"version":3,"sources":["components/svg_todataurl.js"],"names":["module","exports","toDataURL","_svg","type","options","defaultDebug","s","console","log","debug","myCanvg","canvg","window","exportSVG","svg_xml","XMLSerialize","svg_dataurl","base64dataURLencode","length","callback","svg","XMLSerializerForIE","out","nodeName","n","attributes","name","value","hasChildNodes","childNodes","XMLSerializer","serializeToString","b64","btoa","Base64","encode","exportImage","canvas","document","createElement","ctx","getContext","svg_img","Image","src","onload","width","height","drawImage","png_dataurl","onerror","exportImageCanvg","keepBB","keepOutsideViewport","bb","getBBox","ignoreMouse","ignoreAnimation","offsetX","x","undefined","offsetY","y","scaleWidth","scaleHeight","renderCallback","keepNonSafe","renderer"],"mappings":"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","sourcesContent":["/**\n\tThe missing SVG.toDataURL library for your SVG elements.\n\t\n\tUsage: SVGElement.toDataURL( type, { options } )\n\n\tReturns: the data URL, except when using native PNG renderer (needs callback).\n\n\ttype\tMIME type of the exported data.\n\t\t\tDefault: image/svg+xml.\n\t\t\tMust support: image/png.\n\t\t\tAdditional: image/jpeg.\n\n\toptions is a map of options: {\n\t\tcallback: function(dataURL)\n\t\t\tCallback function which is called when the data URL is ready.\n\t\t\tThis is only necessary when using native PNG renderer.\n\t\t\tDefault: undefined.\n\t\t\n\t\t[the rest of the options only apply when type=\"image/png\" or type=\"image/jpeg\"]\n\n\t\trenderer: \"native\"|\"canvg\"\n\t\t\tPNG renderer to use. Native renderer¹ might cause a security exception.\n\t\t\tDefault: canvg if available, otherwise native.\n\n\t\tkeepNonSafe: true|false\n\t\t\tExport non-safe (image and foreignObject) elements.\n\t\t\tThis will set the Canvas origin-clean property to false, if this data is transferred to Canvas.\n\t\t\tDefault: false, to keep origin-clean true.\n\t\t\tNOTE: not currently supported and is just ignored.\n\n\t\tkeepOutsideViewport: true|false\n\t\t\tExport all drawn content, even if not visible.\n\t\t\tDefault: false, export only visible viewport, similar to Canvas toDataURL().\n\t\t\tNOTE: only supported with canvg renderer.\n\t}\n\n\tSee original paper¹ for more info on SVG to Canvas exporting.\n\n\t¹ http://svgopen.org/2010/papers/62-From_SVG_to_Canvas_and_Back/#svg_to_canvas\n*/\n\nmodule.exports = function toDataURL(_svg, type, options) {\n\tfunction defaultDebug(s) {\n\t\tconsole.log(\"SVG.toDataURL:\", s);\n\t}\n  var debug = options && options.debug ? options.debug : defaultDebug;\n  var myCanvg = options && options.canvg ? options.canvg : typeof canvg === 'function' ? canvg : window.canvg;\n\n\tfunction exportSVG() {\n\t\tvar svg_xml = XMLSerialize(_svg);\n\t\tvar svg_dataurl = base64dataURLencode(svg_xml);\n\t\tdebug(type + \" length: \" + svg_dataurl.length);\n\n\t\t// NOTE double data carrier\n\t\tif (options.callback) options.callback(svg_dataurl);\n\t\treturn svg_dataurl;\n\t}\n\n\tfunction XMLSerialize(svg) {\n\n\t\t// quick-n-serialize an SVG dom, needed for IE9 where there's no XMLSerializer nor SVG.xml\n\t\t// s: SVG dom, which is the <svg> elemennt\n\t\tfunction XMLSerializerForIE(s) {\n\t\t\tvar out = \"\";\n\t\t\t\n\t\t\tout += \"<\" + s.nodeName;\n\t\t\tfor (var n = 0; n < s.attributes.length; n++) {\n\t\t\t\tout += \" \" + s.attributes[n].name + \"=\" + \"'\" + s.attributes[n].value + \"'\";\n\t\t\t}\n\t\t\t\n\t\t\tif (s.hasChildNodes()) {\n\t\t\t\tout += \">\\n\";\n\n\t\t\t\tfor (var n = 0; n < s.childNodes.length; n++) {\n\t\t\t\t\tout += XMLSerializerForIE(s.childNodes[n]);\n\t\t\t\t}\n\n\t\t\t\tout += \"</\" + s.nodeName + \">\" + \"\\n\";\n\n\t\t\t} else out += \" />\\n\";\n\n\t\t\treturn out;\n\t\t}\n\n\t\t\n\t\tif (window.XMLSerializer) {\n\t\t\tdebug(\"using standard XMLSerializer.serializeToString\")\n\t\t\treturn (new XMLSerializer()).serializeToString(svg);\n\t\t} else {\n\t\t\tdebug(\"using custom XMLSerializerForIE\")\n\t\t\treturn XMLSerializerForIE(svg);\n\t\t}\n\t\n\t}\n\n\tfunction base64dataURLencode(s) {\n\t\tvar b64 = \"data:image/svg+xml;base64,\";\n\n\t\t// https://developer.mozilla.org/en/DOM/window.btoa\n\t\tif (window.btoa) {\n\t\t\tdebug(\"using window.btoa for base64 encoding\");\n\t\t\tb64 += btoa(s);\n\t\t} else {\n\t\t\tdebug(\"using custom base64 encoder\");\n\t\t\tb64 += Base64.encode(s);\n\t\t}\n\t\t\n\t\treturn b64;\n\t}\n\n\tfunction exportImage(type) {\n\t\tvar canvas = document.createElement(\"canvas\");\n\t\tvar ctx = canvas.getContext('2d');\n\n\t\t// TODO: if (options.keepOutsideViewport), do some translation magic?\n\n\t\tvar svg_img = new Image();\n\t\tvar svg_xml = XMLSerialize(_svg);\n\t\tsvg_img.src = base64dataURLencode(svg_xml);\n\n\t\tsvg_img.onload = function() {\n\t\t\tdebug(\"exported image size: \" + [svg_img.width, svg_img.height])\n\t\t\tcanvas.width = svg_img.width;\n\t\t\tcanvas.height = svg_img.height;\n\t\t\tctx.drawImage(svg_img, 0, 0);\n\n\t\t\t// SECURITY_ERR WILL HAPPEN NOW\n\t\t\tvar png_dataurl = canvas.toDataURL(type);\n\t\t\tdebug(type + \" length: \" + png_dataurl.length);\n\n\t\t\tif (options.callback) options.callback( png_dataurl );\n\t\t\telse debug(\"WARNING: no callback set, so nothing happens.\");\n\t\t}\n\t\t\n\t\tsvg_img.onerror = function() {\n\t\t\tconsole.log(\n\t\t\t\t\"Can't export! Maybe your browser doesn't support \" +\n\t\t\t\t\"SVG in img element or SVG input for Canvas drawImage?\\n\" +\n\t\t\t\t\"http://en.wikipedia.org/wiki/SVG#Native_support\"\n\t\t\t);\n\t\t}\n\n\t\t// NOTE: will not return anything\n\t}\n\n\tfunction exportImageCanvg(type) {\n\t\tvar canvas = document.createElement(\"canvas\");\n\t\tvar ctx = canvas.getContext('2d');\n\t\tvar svg_xml = XMLSerialize(_svg);\n\n\t\t// NOTE: canvg gets the SVG element dimensions incorrectly if not specified as attributes\n\t\t//debug(\"detected svg dimensions \" + [_svg.clientWidth, _svg.clientHeight])\n\t\t//debug(\"canvas dimensions \" + [canvas.width, canvas.height])\n\n\t\tvar keepBB = options.keepOutsideViewport;\n\t\tif (keepBB) var bb = _svg.getBBox();\n\n\t\t// NOTE: this canvg call is synchronous and blocks\n\t\tmyCanvg(canvas, svg_xml, { \n\t\t\tignoreMouse: true, ignoreAnimation: true,\n\t\t\toffsetX: keepBB ? -bb.x : undefined, \n\t\t\toffsetY: keepBB ? -bb.y : undefined,\n\t\t\tscaleWidth: keepBB ? bb.width+bb.x : undefined,\n\t\t\tscaleHeight: keepBB ? bb.height+bb.y : undefined,\n\t\t\trenderCallback: function() {\n\t\t\t\tdebug(\"exported image dimensions \" + [canvas.width, canvas.height]);\n\t\t\t\tvar png_dataurl = canvas.toDataURL(type);\n\t\t\t\tdebug(type + \" length: \" + png_dataurl.length);\n\t\n\t\t\t\tif (options.callback) options.callback( png_dataurl );\n\t\t\t}\n\t\t});\n\n\t\t// NOTE: return in addition to callback\n\t\treturn canvas.toDataURL(type);\n\t}\n\n\t// BEGIN MAIN\n\n\tif (!type) type = \"image/svg+xml\";\n\tif (!options) options = {};\n\n\tif (options.keepNonSafe) debug(\"NOTE: keepNonSafe is NOT supported and will be ignored!\");\n\tif (options.keepOutsideViewport) debug(\"NOTE: keepOutsideViewport is only supported with canvg exporter.\");\n\t\n\tswitch (type) {\n\t\tcase \"image/svg+xml\":\n\t\t\treturn exportSVG();\n\t\t\tbreak;\n\n\t\tcase \"image/png\":\n\t\tcase \"image/jpeg\":\n\n\t\t\tif (!options.renderer) {\n\t\t\t\tif (window.canvg) options.renderer = \"canvg\";\n\t\t\t\telse options.renderer=\"native\";\n\t\t\t}\n\n\t\t\tswitch (options.renderer) {\n\t\t\t\tcase \"canvg\":\n\t\t\t\t\tdebug(\"using canvg renderer for png export\");\n\t\t\t\t\treturn exportImageCanvg(type);\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"native\":\n\t\t\t\t\tdebug(\"using native renderer for png export. THIS MIGHT FAIL.\");\n\t\t\t\t\treturn exportImage(type);\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tdebug(\"unknown png renderer given, doing noting (\" + options.renderer + \")\");\n\t\t\t}\n\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tdebug(\"Sorry! Exporting as '\" + type + \"' is not supported!\")\n\t}\n}"],"file":"svg_todataurl.js"}